@{
    ViewData["Title"] = "Orders";
}

<div id="Navbar" class="mb-4"></div>
<div class="container-fluid p-4">
    <div class="row mb-4">
        <div class="col-12 col-md-6">
            <h2 class="text-dark fw-bold">My Orders</h2>
        </div>
        <div class="col-12 col-md-6 d-flex justify-content-end align-items-center gap-3">
            <input type="text" id="ordersSearchInput" class="form-control w-50" placeholder="Search by customer or item name">
            <div class="d-flex align-items-center">
                <span class="me-2">Orders per page:</span>
                <select id="ordersPerPage" class="form-select">
                    <option value="15" selected>15</option>
                    <option value="30">30</option>
                    <option value="50">50</option>
                </select>
            </div>
            <button class="btn btn-primary ms-3 saveOrder" data-bs-toggle="modal" data-bs-target="#SaveOrderModal" data-id="0">
                <i class="bi bi-plus-circle me-2"></i>Place Order
            </button>
        </div>
    </div>

    <div id="orderList" class="row g-4"></div>
    <div id="loading" class="text-center mt-4 d-none">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
    <div id="noMoreOrders" class="text-center mt-4 d-none">
        <p class="text-muted">No more orders to load</p>
    </div>
</div>

@section Scripts {
    <style>
        .order-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .order-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1) !important;
        }
    </style>
    <script>
        let ordersCurrentPage = 1;
        let ordersPageSize = $("#ordersPerPage").val();
        let ordersSearchText = "";
        let ordersSortColumn = "ID";
        let ordersSortDirection = "asc";
        let ordersIsLoading = false;
        let ordersHasMore = true;

        function loadNavbar() {
            $.ajax({
                url: "/User/GetUserNavbarData",
                type: "GET",
                success: function(data) {
                    $("#Navbar").html(data);
                },
                error: function() {
                    console.error("Error loading navbar");
                }
            });
        }

        function loadOrdersForTab(append = true) {
            if (ordersIsLoading || !ordersHasMore) return;
            ordersIsLoading = true;
            $("#loading").removeClass("d-none");

            $.ajax({
                url: "/User/GetOrderList",
                type: "GET",
                data: { pageNumber: ordersCurrentPage, search: ordersSearchText, pageSize: ordersPageSize, sortColumn: ordersSortColumn, sortDirection: ordersSortDirection },
                success: function(data) {
                    if (append) {
                        $("#orderList").append(data);
                    } else {
                        $("#orderList").html(data);
                    }

                    const totalRecords = parseInt($("#totalRecords").val()) || 0;
                    if (ordersCurrentPage * ordersPageSize >= totalRecords) {
                        ordersHasMore = false;
                        $("#noMoreOrders").removeClass("d-none");
                    }
                    ordersCurrentPage++;
                    ordersIsLoading = false;
                    $("#loading").addClass("d-none");
                },
                error: function() {
                    ordersIsLoading = false;
                    $("#loading").addClass("d-none");
                    console.error("Error loading orders");
                }
            });
        }

        $(document).ready(function() {
            loadNavbar();
            loadOrdersForTab(false);

            // Infinite scrolling
            $(window).scroll(function() {
                if ($(window).scrollTop() + $(window).height() >= $(document).height() - 100 && $("#orders-content").hasClass("show")) {
                    loadOrdersForTab();
                }
            });

            // Search
            $("#ordersSearchInput").on("keyup", _.debounce(function() {
                ordersSearchText = $(this).val().trim();
                ordersCurrentPage = 1;
                ordersHasMore = true;
                $("#noMoreOrders").addClass("d-none");
                loadOrdersForTab(false);
            }, 300));

            // Orders per page
            $("#ordersPerPage").on("change", function() {
                ordersPageSize = $(this).val();
                ordersCurrentPage = 1;
                ordersHasMore = true;
                $("#noMoreOrders").addClass("d-none");
                loadOrdersForTab(false);
            });
        });
    </script>
}